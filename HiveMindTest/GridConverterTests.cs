using System.IO;
using FluentAssertions;
using Google.Protobuf;
using HiveMind;
using NUnit.Framework;
using SC2APIProtocol;

namespace HiveMindTest
{
    public class GridConverterTests
    {
        private ResponseGameInfo _gameInfo;

        [SetUp]
        public void Setup()
        {
            // From AcropolisLE.SC2Map
            var mapSize = new Size2DI { X = 176, Y = 184 };
            _gameInfo = new ResponseGameInfo
            {
                StartRaw = new StartRaw
                {
                    MapSize = mapSize,
                    PathingGrid = new ImageData
                    {
                        BitsPerPixel = 1,
                        Size = mapSize,
                        Data = ByteString.FromBase64(PathingGridBitmap)
                    },
                    PlacementGrid = new ImageData
                    {
                        BitsPerPixel = 1,
                        Size = mapSize,
                        Data = ByteString.FromBase64(PlacementGridBitmap)
                    },
                    PlayableArea = new RectangleI
                    {
                        P0 = new PointI { X = 18, Y = 18 },
                        P1 = new PointI { X = 156, Y = 153 }
                    }
                }
            };

            // Test grid setup
            GridConverter.GetDataValueBit(_gameInfo.StartRaw.PathingGrid, 22, 131).Should().Be(1);
            GridConverter.GetDataValueBit(_gameInfo.StartRaw.PlacementGrid, 22, 131).Should().Be(1);
            GridConverter.GetDataValueBit(_gameInfo.StartRaw.PathingGrid, 40, 124).Should().Be(1);
            GridConverter.GetDataValueBit(_gameInfo.StartRaw.PlacementGrid, 40, 123).Should().Be(0);
        }

        [Test]
        public void MapGridSetup()
        {
            var groundMatrix = GridConverter.ToGroundTypeMatrix(_gameInfo.StartRaw.PlacementGrid, _gameInfo.StartRaw.PathingGrid, _gameInfo.StartRaw.PlayableArea);

            groundMatrix[20, 130].Should().Be(Ground.Airspace);
            groundMatrix[21, 130].Should().Be(Ground.BuildingPlacable);
            groundMatrix[39, 123].Should().Be(Ground.Pathable); // Top left of ramp
            groundMatrix[37, 118].Should().Be(Ground.Pathable); // Bottom right of ramp (ramp points to left)
        }


        private const string PathingGridBitmap = @"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/gYeAAAAAAAAAAAAAAAAAAAAAAAAA////+AAAAAAAAAAAAAAAAAAAAAAAAf////wAAAAAAAAAAAAAAAAAAAAAAD/////+AAAAf8AAAAP/8AAAAAAAAAB//////wAAAP/gAAAH//gAAAAAAAAAf/////+AAAH/8AAAD//8AAAAAAAAAH//////wAAD//gAAB///gAAAAAAAAD///////8AB//8AAD///8AAAAAAAAB////////gA///gAB////gAAAAAAAAf////////Af//8AA////8AAAAAAAAH/////n//4P///gAf////gAAAAAAAB/////w///H///8AH////4AAAAAAAAP////8H//7////AB////+AAAAAAAAB/////B//+////wAf////gAAAAAAAAf////gf//v///8AH////4AAAAAAAAH////z///7////AB////+AAAAAAAAA////5///+f///wAf////gAAAAAAAAH///8////j///8AP////4AAAAAAAAB///+f///8////AH////+AAAAAAAAAf///P////v///wB/////gAAAAAAAAD///3////////8Af////4AAAAAAAPAf//x/////////33////+AAAAAAAH4H//4f//9/////gB/////gAAAAAAB////8H//+P/8//wAf////4AAAAAAAf////B///h/+H/4AD////8AAAAAAD/////4f//4P/h/8AAf///+AAAAAAB//////H//+D/4f+AAH////AAAAAAAf/////////h/+H/AAB////gAAAAAAH////////+D//h/gAAf///wAAAAAAD/////////A//4P4AAH/4fgAAAAAAA/////f///gP//D+AAA/+DzgAAAAAAP////z///wD//5/wAAH/gB8AAAAAAD////4f//8A////+AAA/8P/gAAAAAA////8H///Af////wAAHjn/8AAAAAAP///+B///wP/////4AAwf//gAAAAAD////Af//gH/////+YAAD//8AAAAAA////gH//4P///////gBD///gAAAAAP///wB//+D////////Af///4AAAAAD///4AP//w////////4H///+AAAAAA///8AB//+f///////+B////gAAAAAP///AAP/////AD////gf///4AAAAAB///4PAf////4Af///8H///+AAAAAAf///H4D/////AD///+B////gAAAAAH/////AA////4Af///gf///4AAAAAAf////4AH////AD///8H///+AAAAAAH////+AA////4A////B////gAAAAAAwAf//gAP////AH///wJ///wAAAAAAAAD//8AH////4A///+AP//4AAAAAAAAAf//gB//3//AP///wD//8AAAAAAAAAH//4A//4//4D///+B//+AAAAAAAAAB//+Af/8H/+A////wf+HAAAAAAAAAAf//gP/+B//gf///+H/AAAAAAAAAAAH//8H/+Af/4P/5//x/wAAAAAAAAAAD///j//AP/+H/8P///8AAAAAAAAAAB//////gD//j//D////AAAAAAAAAA8P/////wA/////5////4AAAAAAAAAfD/////8AH//////4f//gAAAAAAAAP5/+P///AA//////8D//8AAAAAAAAH///h///wAP/////9A///gAAAAAAAD///4P//+GD//////Af//8AAAAAAAB///4B//3/wf///v/gP///gAAAAAAA///8AP/8/+D///z/wH///8AAAAAAAf///AD/+H/w///4/8H////gAAAAAAH///wA//h/+f//+f/B////4AAAAAAB///8AP/4f/////H/wf///+AAAAAAAf///gD/+H/////h/8H////wAAAAAAH///8A//w/////4f/A////+AAAAAAB////gP/8P////+H/4H////gAAAAAAf///+B/+H/////D//Af///4AAAAAAH////wP/h/////w//wD///+AAAAAAA////+D/4f////+H/8Af///gAAAAAAH////g/+P/////h//AD///4AAAAAAB////4P/n///n/4f/wA///+AAAAAAAf///+D/x///w/+H/8AP///gAAAAAAD///+A/8///8H/z//AD///wAAAAAAAf///Af/f///g/+//4B///4AAAAAAAD///gP/////8GH///B///8AAAAAAAAf//wL//////AA///4f//+AAAAAAAAD//8D//////wAP///H/5/AAAAAAAAAf//h//////+AD/////8PgAAAAAAAAB////5/////wA//////DwAAAAAAAAAP///8P/8f/8Af/////4AAAAAAAAAAD////D/+H//AP/8f//8AAAAAAAAAAA/4//5//B//gH/+D//+AAAAAAAAAAAP+H////gf/4H//Af//gAAAAAAAAAOH/g////wH/+D//gH//4AAAAAAAAAH//4H///8B//x//wB//+AAAAAAAAAD//8A////AP/+//4Af//gAAAAAAAAB///AH///wB////+AD//8AAAAAAAAA///5A///+AP////AAf//gAwAAAAAAf///4P///wB////wAH////+AAAAAAH///+D///8AP///+AB/////gAAAAAB////gf///gB////wAP////+AAAAAAf///4H///8AP////8B+P///gAAAAAH///+D////gB/////gPB///4AAAAAB////gf///8AP/////AAP///AAAAAAf///4H////////n//4AD///wAAAAAH///+B////////w///AB///8AAAAAB////gP///////8H//4A////AAAAAAf//8IAf///////B//+Af///wAAAAAD//8AABn/////+Af//gP///8AAAAAAf//gwAB//////A///4H////AAAAAAD/+ceAAA/////gP//+D////wAAAAAAf/D/wAAH////wD///h////8AAAAAAD4Af+AAA/5//8A///8/////AAAAAAAc8H/wAAH8P//Af///v////wAAAAAAAfh/+AAB/B//wP////////8AAAAAAA////gAAf4f/8H////////+AAAAAAAf///4AAP+H/4f/////////gAAAAAAP///+AAH/h/8H//+P/////4AAAAAAH////gAD/4f/B///h/////8AAAAAAD////8AB/+H/4f//4P////gAAAAAAB/////gA//z//H//+D////4AAAAAAAf////4Af////7///h//+B+AAAAAAAH////++/////////4///gPAAAAAAAB/////gD////////+///8AAAAAAAAAeP///4A////f////P///gAAAAAAAAHj///+AP///z////n///4AAAAAAAAB48f//AD///8f///z///+AAAAAAAAAf+D//gA////n///5////wAAAAAAAAHzg//4AP///9///8////+AAAAAAAAB54P/+AD////f//gf////gAAAAAAAAfPH//gA////3//4P////4AAAAAAAAH////4AP///9//+D/////AAAAAAAAB8///+AD///+P//w/////4AAAAAAAAfn///gAf///B//+f////+AAAAAAAAD/JH/wAD///gP////////gAAAAAAAAf8x/4AAf//wAf///////4AAAAAAAAD/8f8AAD//4AD///////8AAAAAAAAAf//4AAAf/8AAA//////+AAAAAAAAAD//8AAAD/+AAAH//////gAAAAAAAAAf/+AAAAf/AAAA//////4AAAAAAAAAD//AAAAD/gAAAH/////8AAAAAAAAAAAAAAAAAAAAAAA/////gAAAAAAAAAAAAAAAAAAAAAAAH////wAAAAAAAAAAAAAAAAAAAAAAAAHhgf4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
        private const string PlacementGridBitmap = @"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/gYeAAAAAAAAAAAAAAAAAAAAAAAAA////+AAAAAAAAAAAAAAAAAAAAAAAAf////wAAAAAAAAAAAAAAAAAAAAAAD/////+AAAAf8AAAAP/8AAAAAAAAAB//////gAAAP/gAAAH//gAAAAAAAAAf/////wAAAH/8AAAD//8AAAAAAAAAH/////4AAAD//gAAB///gAAAAAAAAD/////8A8AB//8AAD///8AAAAAAAAB/////+APgA///gAB////gAAAAAAAAf/////AH/Af//8AA////8AAAAAAAAH/////gD/4P///gAf////gAAAAAAAB/////wB//H///8AH////4AAAAAAAAP////8A//7////AB////+AAAAAAAAB/////Af/+////wAf////gAAAAAAAAf////gf//v///8AH////4AAAAAAAAH////z///7////AB////+AAAAAAAAA////5///4f///wAf////gAAAAAAAAH///8///8D///8AP////4AAAAAAAAB///+f//+A////AH////+AAAAAAAAAf///P///AP///wB/////gAAAAAAAAD///3///gD///8Af////4AAAAAAAPAf//x///wB////33////+AAAAAAAH4H//4f//8A////gB/////gAAAAAAB////8H//+Af8//wAf////4AAAAAAAf///+B///gP+H/4AD////8AAAAAAD/////Af//4H/h/8AAf///+AAAAAAB/////gH//+D/4f+AAH////AAAAAAAf////wD///h/+H/AAB////gAAAAAAH////4A//+D//h/gAAf///wAAAAAAD////8Af//A//4P4AAH/4fgAAAAAAA/////AP//gP//D+AAA/4DzgAAAAAAP////wH//wD//5/wAAH8AB8AAAAAAD////4D//8A////+AAA/AP/gAAAAAA////8B///Af////wAAHgH/8AAAAAAP///+B///wP/////4AAwD//gAAAAAD////Af//gH/////+YAAB//8AAAAAA////gH//gP///////gBD///gAAAAAP///wB//wD////////Af///4AAAAAD///4AP/4A////////4H///+AAAAAA///8AB/8Af///////+B////gAAAAAP//+AAP+AP/+AD////gf///4AAAAAB///APAfAH//AAf///8H///+AAAAAAf//gH4DwD//gAD///+B////gAAAAAH//wD/AAB//wAAf///gf///4AAAAAAf/4A/4AA//4AAD///8H///+AAAAAAH/8Af+AAf/8AYA////B////gAAAAAAwAAP/gAD/+APAH///wJ///wAAAAAAAAAH/8AGf/AH4A///+AP//4AAAAAAAAAD//gBz/wD/AP///wD//8AAAAAAAAAB//4A+f4B/4D///+B//+AAAAAAAAAB//4Afz8A/+A////gf+HAAAAAAAAAAf/8AP+eAf/gf///wH/AAAAAAAAAAAH/+AH/yAf/4H/5/4B/wAAAAAAAAAAD//AD/+AP/+A/8P8A/8AAAAAAAAAAB//gD//gD//gH/D+AP/AAAAAAAAAA8P/wB//wA//8A/5/AH/4AAAAAAAAAfD/8A//4AH//AH//gD//gAAAAAAAAP5/+Af/8AA//4A//wB//8AAAAAAAAH///gP/+AAP//AH/8A///gAAAAAAAD///4H//AGD//4A//Af//8AAAAAAAB///4B//wDwf//AP3gP///gAAAAAAA///8AP/8B+D//4D4wH///8AAAAAAAf///AD/+A/w///A/EH////gAAAAAAH///wA//gf+P//4f4B////4AAAAAAB///8AP/4f/5///H/Af///+AAAAAAAf///gD/+H//P//h/8H////wAAAAAAH///8A//w//7//4f/A////+AAAAAAB////gP/8P////+H/4H////gAAAAAAf///+B/+H/////D//Af///4AAAAAAH////wP/h//9//w//wD///+AAAAAAA////+D/4f//P/+H/8Af///gAAAAAAH////gP+P//5//h//AD///4AAAAAAB////4B/h///H/gf/wA///+AAAAAAAf///+CPwP//w/wH/8AP///gAAAAAAD///+Ax8B//8H4D//AD///wAAAAAAAf///Ae/AP//g8A//4B///4AAAAAAAD///gP/wB//8GAP/+B///8AAAAAAAAf//wD/+AP//AAH//Af//+AAAAAAAAD//4A//wB//wAD//gH/5/AAAAAAAAAf/8Af/+AP/+AB//wD/8PgAAAAAAAAB/+AP5/wD//wA//4A//DwAAAAAAAAAP/AH8P+Af/8Af/8Af/4AAAAAAAAAAD/wD/D/wH//AH/8AP/8AAAAAAAAAAA/4B/5/+B//gE/+AH/+AAAAAAAAAAAP+A////gf/gHn/AD//gAAAAAAAAAOH/gf///wH/wD8/gB//4AAAAAAAAAH//4H///8B/4B/nwB//4AAAAAAAAAD//8A////AP8A/84Af/8AAAAAAAAAB///AH///wB+AP/mAD/+AAAAAAAAAA///5A///+APAH/8AAf/AAAwAAAAAAf///4P///wBgD//gAH/gD/+AAAAAAH///+D///8AAB//wAB/wB//gAAAAAB////gf///gAA//4AAP8A//+AAAAAAf///4H///8AAf/8A8B+Af//gAAAAAH///+D////gAP/+APgPAP//4AAAAAB////gf///8AH//AH/AAH///AAAAAAf///4H////////gD/4AD///wAAAAAH///+B////////wB//AB///8AAAAAB////gP///////8A//4A////AAAAAAf//8IAf///////Af/+Af///wAAAAAD//4AABn/////+Af//gP///8AAAAAAf/8AwAB//////A///4H////AAAAAAD/+AeAAA/////gP//4D////wAAAAAAf/APwAAH////wD//8B////8AAAAAAD4AD+AAA/5//8A//+A/////AAAAAAAc8B/wAAH8P//Af//AP////wAAAAAAAfh/+AAB/B//wP//gD////8AAAAAAA////gAAf4f/8H//wB////+AAAAAAAf///4AAP+H/4f//8A/////gAAAAAAP///+AAH/h/8H//+Af////4AAAAAAH////gAD/4f+B///gP////8AAAAAAD////8AB/+H/Af//4H////gAAAAAAB/////gA//z/gH//+D////4AAAAAAAf////4Af///wD///h//+B+AAAAAAAH////++////4A///4///gPAAAAAAAB/////gD///8Af//+///8AAAAAAAAAf////4A////AP///P///gAAAAAAAAH////+AP///wH///n///4AAAAAAAAB/////AD///8D///z///+AAAAAAAAAf////gA////h///5////wAAAAAAAAH////4AP///9///8////+AAAAAAAAB////+AD////f//gf////gAAAAAAAAf////gA////3//gP////4AAAAAAAAH////4AP///9//wD/////AAAAAAAAB////+AD///+P/4A/////4AAAAAAAAf////gAf///B/8Af////+AAAAAAAAD////wAD///gP+AP/////gAAAAAAAAf///4AAf//wAfAH/////4AAAAAAAAD///8AAD//4ADwD/////8AAAAAAAAAf//4AAAf/8AAAB/////+AAAAAAAAAD//8AAAD/+AAAA//////gAAAAAAAAAf/+AAAAf/AAAAf/////4AAAAAAAAAD//AAAAD/gAAAH/////8AAAAAAAAAAAAAAAAAAAAAAA/////gAAAAAAAAAAAAAAAAAAAAAAAH////wAAAAAAAAAAAAAAAAAAAAAAAAHhgf4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==";
    }
}